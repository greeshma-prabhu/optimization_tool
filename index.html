<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Optimization - Zuidplas Logistics</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/layout.css">
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="header-left">
            <div class="header-logo">
                <div class="logo-blocks">
                    <div class="logo-block d">D</div>
                    <div class="logo-block flower">
                        <div class="logo-flower-icon"></div>
                    </div>
                    <div class="logo-block z">Z</div>
                </div>
                <div class="logo-text-large">
                    <div class="logo-main-text">DE ZUIDPLAS</div>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="user-menu">
                <div class="user-avatar">A</div>
                <span style="font-size: 14px; color: #374151;">Admin User</span>
                <div class="user-badge">Admin</div>
            </div>
            <button class="logout-btn-header" onclick="handleLogout()" data-i18n="common.logout">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span>Uitloggen</span>
            </button>
        </div>
    </header>

    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-items">
            <a href="index.html" class="nav-item active">
                <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                <span data-i18n="nav.dashboard">Dashboard</span>
            </a>
            
            <a href="orders.html" class="nav-item">
                <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                </svg>
                <span data-i18n="nav.orders">Orders</span>
            </a>
            
            <a href="optimization.html" class="nav-item">
                <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polyline>
                </svg>
                <span data-i18n="nav.optimization">Optimization</span>
            </a>
            
            <a href="cart-loading.html" class="nav-item">
                <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="7" width="20" height="14" rx="2"></rect>
                    <path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"></path>
                    <line x1="12" y1="12" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="8" y2="16"></line>
                    <line x1="16" y1="12" x2="16" y2="16"></line>
                </svg>
                <span data-i18n="nav.cartOptimization">Cart Optimization</span>
            </a>
            
            <a href="trucks.html" class="nav-item">
                <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="3" width="15" height="13"></rect>
                    <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                </svg>
                <span data-i18n="nav.trucks">Trucks</span>
            </a>
            
            <a href="costs.html" class="nav-item">
                <svg class="nav-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
                <span data-i18n="nav.costs">Costs</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-top">
                <div>
                    <h1 class="page-title" data-i18n="dashboard.title">Dashboard</h1>
                    <p class="page-subtitle" data-i18n="dashboard.subtitle">Route optimization overview for today</p>
                </div>
                <div class="dashboard-controls">
                    <div class="date-picker-wrapper">
                        <label class="date-picker-label" data-i18n="dashboard.selectDate">Select Date</label>
                        <div class="date-input-group">
                            <input type="date" id="order-date-picker" class="date-input" value="">
                            <button type="button" class="btn-icon" onclick="document.getElementById('order-date-picker').focus(); document.getElementById('order-date-picker').showPicker ? document.getElementById('order-date-picker').showPicker() : null;" title="Open calendar">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn-sync" id="sync-btn" title="Sync data for selected date" onclick="syncDataForDate()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"></path>
                            </svg>
                            <span data-i18n="dashboard.syncOrders">Sync</span>
                        </button>
                        <button type="button" class="btn-refresh" id="refresh-btn" title="Refresh today's orders (yesterday until 7 AM)" onclick="refreshTodaysOrders()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="refresh-icon">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <polyline points="1 20 1 14 7 14"></polyline>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            <span data-i18n="dashboard.refresh">Refresh Data</span>
                        </button>
                        <button type="button" class="btn-demo" id="demo-btn" title="Load demo data" onclick="loadDemoData()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="3" x2="9" y2="21"></line>
                                <line x1="15" y1="3" x2="15" y2="21"></line>
                                <line x1="3" y1="9" x2="21" y2="9"></line>
                                <line x1="3" y1="15" x2="21" y2="15"></line>
                            </svg>
                            <span data-i18n="dashboard.loadDemo">Demo</span>
                        </button>
                    </div>
                    <div class="header-status-info">
                        <!-- Removed "Last updated" - only showing "Last refreshed" below -->
                    </div>
                    <div class="current-date-time" id="currentDateTime"></div>
                </div>
            </div>
            <div id="api-status-message" class="api-status-message"></div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="total-orders-count">0</div>
                        <div class="stat-label" data-i18n="dashboard.todayOrders">Today's Orders</div>
                    </div>
                    <div class="stat-icon-wrapper">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="total-carts-needed">0</div>
                        <div class="stat-label" data-i18n="dashboard.totalCarts">Total Carts Needed</div>
                    </div>
                    <div class="stat-icon-wrapper">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="routes-status">0/3</div>
                        <div class="stat-label" data-i18n="dashboard.routesStatus">Active Routes</div>
                    </div>
                    <div class="stat-icon-wrapper">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="3" width="15" height="13"></rect>
                            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                            <circle cx="5.5" cy="18.5" r="2.5"></circle>
                            <circle cx="18.5" cy="18.5" r="2.5"></circle>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="optimization-score">0%</div>
                        <div class="stat-label" data-i18n="dashboard.optimizationScore">Optimization Score</div>
                    </div>
                    <div class="stat-icon-wrapper">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polyline>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Route Overview Cards -->
        <div class="card">
            <h2 data-i18n="dashboard.routeOverview">Route Overview</h2>
            <div class="route-grid" id="route-overview">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Optimization Suggestions -->
        <div class="card">
            <h2 data-i18n="dashboard.optimizationSuggestions">Optimization Suggestions</h2>
            <div id="optimization-suggestions">
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);" data-i18n="dashboard.clickToSync">
                    Click "Sync Orders from API" to fetch real orders, or "Load Demo Data" to test with sample orders
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="info-box danger" style="display: none; margin-top: 20px;"></div>
        
        <!-- Info Message -->
        <div id="info-message" class="info-box info" style="display: none; margin-top: 20px;"></div>
    </main>

    <!-- LANGUAGE SCRIPTS - MUST BE FIRST -->
    <script src="js/i18n.js"></script>
    <script src="js/i18n-init.js"></script>
    
    <!-- GLOBAL STATE MANAGER - BEFORE PAGE SCRIPTS -->
    <script src="js/app-state.js"></script>
    
    <!-- PAGE-SPECIFIC SCRIPTS -->
    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/cart-calculation.js"></script> <!-- NEW CORRECT CALCULATION -->
    <script src="js/order-validator.js"></script> <!-- ORDER VALIDATION -->
    <script src="js/carts.js"></script>
    <script src="js/ordermanager-shim.js"></script>
    <script src="js/orders.js"></script>
    <script src="js/optimizer.js"></script>
    <script src="js/navigation.js"></script>
    <script>
        // Update last refreshed time
        function updateLastRefreshed() {
            const lastRefresh = localStorage.getItem('zuidplas_last_refresh');
            const dateTimeEl = document.getElementById('currentDateTime');
            if (!dateTimeEl) return;
            
            const lang = localStorage.getItem('zuidplas_user_language') || localStorage.getItem('zuidplas_language') || 'nl';
            const locale = lang === 'nl' ? 'nl-NL' : 'en-US';
            
            if (lastRefresh) {
                const refreshDate = new Date(parseInt(lastRefresh));
                const timeStr = refreshDate.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
                const dateStr = refreshDate.toLocaleDateString(locale, { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                });
                
                if (lang === 'nl') {
                    dateTimeEl.textContent = `Laatst vernieuwd: ${dateStr} om ${timeStr}`;
                } else {
                    dateTimeEl.textContent = `Last refreshed: ${dateStr} at ${timeStr}`;
                }
            } else {
                if (lang === 'nl') {
                    dateTimeEl.textContent = 'Nog niet vernieuwd';
                } else {
                    dateTimeEl.textContent = 'Not refreshed yet';
                }
            }
        }

        // Update last updated time display
        function updateLastUpdatedTime() {
            const now = new Date();
            const lang = localStorage.getItem('zuidplas_user_language') || localStorage.getItem('zuidplas_language') || 'nl';
            const locale = lang === 'nl' ? 'nl-NL' : 'en-US';
            const timeStr = now.toLocaleTimeString(locale, { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const element = document.getElementById('lastUpdatedTime');
            if (element) {
                element.textContent = timeStr;
            }
        }
        
        // Update on load
        updateLastRefreshed();
        updateLastUpdatedTime();
        
        // Set default date to today and set up button listeners
        document.addEventListener('DOMContentLoaded', () => {
            const datePicker = document.getElementById('order-date-picker');
            if (datePicker && !datePicker.value) {
                const today = new Date();
                datePicker.value = today.toISOString().split('T')[0];
            }
            
            // Set up button event listeners (CRITICAL - must prevent calendar opening)
            const syncBtn = document.getElementById('sync-btn');
            const demoBtn = document.getElementById('demo-btn');
            
            if (syncBtn) {
                // Ensure button type is set
                syncBtn.setAttribute('type', 'button');
                
                // Remove any existing listeners by cloning
                const newSyncBtn = syncBtn.cloneNode(true);
                syncBtn.parentNode.replaceChild(newSyncBtn, syncBtn);
                
                // Get reference to the new button
                const finalSyncBtn = document.getElementById('sync-btn');
                
                finalSyncBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('Sync button clicked - calling syncOrders');
                    
                    if (typeof window.syncOrders === 'function') {
                        window.syncOrders(false);
                    } else if (typeof syncOrders === 'function') {
                        syncOrders(false);
                    } else {
                        console.error('syncOrders function not found!');
                    }
                    return false;
                }, false); // Use bubble phase, not capture
            }
            
            if (demoBtn) {
                // Ensure button type is set
                demoBtn.setAttribute('type', 'button');
                
                // Remove any existing listeners by cloning
                const newDemoBtn = demoBtn.cloneNode(true);
                demoBtn.parentNode.replaceChild(newDemoBtn, demoBtn);
                
                // Get reference to the new button
                const finalDemoBtn = document.getElementById('demo-btn');
                
                finalDemoBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('Demo button clicked - calling loadDemoData');
                    
                    if (typeof window.loadDemoData === 'function') {
                        window.loadDemoData();
                    } else if (typeof loadDemoData === 'function') {
                        loadDemoData();
                    } else {
                        console.error('loadDemoData function not found!');
                    }
                    return false;
                }, false); // Use bubble phase, not capture
            }
            
            // Prevent date picker from interfering with buttons
            if (datePicker) {
                datePicker.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        });

        // Use dummy data flag
        let useDummyData = false;
        window.isRefreshing = false;
        
        // OrderManager is provided by ordermanager-shim.js - DO NOT DECLARE IT HERE!

        // Sync data for selected date - uses date picker
        // Make it available globally immediately
        function syncDataForDate() {
            return window.syncDataForDate();
        }
        
        window.syncDataForDate = async function() {
            if (window.isRefreshing) {
                console.log('Sync already in progress...');
                return;
            }
            
            console.log('üîÑ Sync data for selected date');
            
            window.isRefreshing = true;
            const btn = document.getElementById('sync-btn');
            if (btn) {
                btn.classList.add('refreshing');
                btn.disabled = true;
            }
            
            try {
                await window.syncOrders(false);
            } catch (error) {
                console.error('Sync failed:', error);
            } finally {
                window.isRefreshing = false;
                if (btn) {
                    btn.classList.remove('refreshing');
                    btn.disabled = false;
                }
            }
        };

        // Refresh today's orders (yesterday until 7 AM today) - planning window
        window.refreshTodaysOrders = async function() {
            if (window.isRefreshing) {
                console.log('Refresh already in progress...');
                return;
            }
            
            console.log('üîÑ Refresh today\'s orders (planning window)');
            
            window.isRefreshing = true;
            const btn = document.getElementById('refresh-btn');
            const statusMsg = document.getElementById('api-status-message');
            
            if (btn) {
                btn.classList.add('refreshing');
                btn.disabled = true;
            }
            
            try {
                if (statusMsg) {
                    statusMsg.innerHTML = '';
                    statusMsg.classList.remove('show', 'success', 'error');
                }
                
                // Store refresh timestamp
                localStorage.setItem('zuidplas_last_refresh', Date.now().toString());
                updateLastRefreshed();
                updateLastUpdatedTime();
                
                // Get selected date from date picker (same as sync)
                const datePicker = document.getElementById('order-date-picker');
                let selectedDate = null;
                if (datePicker && datePicker.value) {
                    selectedDate = new Date(datePicker.value);
                    console.log('üìÖ Refresh: Using selected date from picker:', selectedDate.toISOString().split('T')[0]);
                } else {
                    // Default to today
                    selectedDate = new Date();
                    if (datePicker) {
                        datePicker.value = selectedDate.toISOString().split('T')[0];
                    }
                    console.log('üìÖ Refresh: Using today as default:', selectedDate.toISOString().split('T')[0]);
                }
                
                // Fetch orders for the selected date (same as sync)
                console.log('üìÖ Fetching orders for selected date:', selectedDate.toISOString().split('T')[0]);
                const apiOrders = await florinetAPI.fetchOrdersForDate(selectedDate);
                
                if (apiOrders && apiOrders.length > 0) {
                    console.log('‚úÖ Loaded', apiOrders.length, 'raw orders from API');
                    
                    // VALIDATE ORDERS - filter out invalid/test/cancelled/duplicates
                    let orders = apiOrders;
                    if (window.OrderValidator && typeof window.OrderValidator.validateOrders === 'function') {
                        const validationResult = window.OrderValidator.validateOrders(apiOrders);
                        orders = validationResult.orders;
                        console.log('‚úÖ Processing', orders.length, 'valid orders after validation');
                    } else {
                        console.log('‚ö†Ô∏è Order validator not available, using all orders');
                    }
                    
                    // Initialize optimizer
                    const optimizer = initializeOptimizer(orders);
                    const options = optimizer.generateOptions();
                    
                    // Update dashboard
                    updateDashboard(orders, options);
                    
                    // Get existing orders count for comparison
                    const existingCount = window.appState.getOrderCount();
                    const hasChanges = orders.length !== existingCount;
                    
                    if (hasChanges) {
                        console.log(`üîÑ Changes detected: ${existingCount} ‚Üí ${orders.length} orders`);
                    } else {
                        console.log('‚ÑπÔ∏è No changes detected - same number of orders');
                    }
                    
                    // STORE IN GLOBAL STATE (handles localStorage automatically)
                    console.log(`üîÑ Saving ${ordersWithCarts.length} orders to global state...`);
                    window.appState.setOrders(ordersWithCarts, selectedDate);
                    
                    // Update debug panel
                    setTimeout(() => {
                        updateDebugPanel();
                    }, 100);
                    
                    // Clear previous truck assignments
                    localStorage.removeItem('zuidplas_route_truck_assignments');
                    
                    // Update last updated time
                    updateLastUpdatedTime();
                    
                    // Show success message with change info
                    if (statusMsg) {
                        if (hasChanges) {
                            statusMsg.innerHTML = `‚úÖ Updated: Found ${ordersWithCarts.length} orders (was ${existingCount})`;
                        } else {
                            statusMsg.innerHTML = `‚úÖ Refreshed: ${ordersWithCarts.length} orders (no changes)`;
                        }
                        statusMsg.classList.add('show', 'success');
                    }
                    
                    console.log('‚úÖ Today\'s orders refreshed:', ordersWithCarts.length, hasChanges ? '(updated)' : '(no changes)');
                } else {
                    console.log('‚ÑπÔ∏è No orders for today\'s planning window');
                    if (statusMsg) {
                        statusMsg.innerHTML = '‚ÑπÔ∏è No orders found for today\'s planning window (yesterday until 7 AM today)';
                        statusMsg.classList.add('show');
                    }
                }
            } catch (error) {
                console.error('Refresh today\'s orders failed:', error);
                if (statusMsg) {
                    statusMsg.innerHTML = `
                        <div style="padding: 16px; background: #fee2e2; border-left: 4px solid #ef4444; border-radius: 8px;">
                            <strong style="color: #991b1b;">‚ùå Failed to refresh today's orders</strong><br>
                            <small style="color: #7f1d1d;">${error.message}</small>
                        </div>
                    `;
                    statusMsg.classList.add('show', 'error');
                }
            } finally {
                window.isRefreshing = false;
                if (btn) {
                    btn.classList.remove('refreshing');
                    btn.disabled = false;
                }
            }
        };

        // Sync orders from API or use dummy data - make it global
        window.syncOrders = async function(useDummy = false) {
            const syncBtn = document.getElementById('sync-btn');
            const originalText = syncBtn ? syncBtn.innerHTML : '';
            const statusMsg = document.getElementById('api-status-message');
            useDummyData = useDummy;
            
            try {
                if (syncBtn) {
                    syncBtn.disabled = true;
                    const btnText = typeof i18n !== 'undefined' 
                        ? (useDummy ? i18n.t('dashboard.loadingDemo', 'Loading Demo Data...') : i18n.t('dashboard.syncing', 'Syncing...'))
                        : (useDummy ? 'üì¶ Loading Demo Data...' : '‚è≥ Syncing...');
                    syncBtn.innerHTML = btnText;
                }
                if (statusMsg) {
                    statusMsg.innerHTML = '';
                    statusMsg.classList.remove('show', 'success', 'error');
                }
                
                // Store refresh timestamp
                localStorage.setItem('zuidplas_last_refresh', Date.now().toString());
                updateLastRefreshed();
                updateLastUpdatedTime();
                
                // Get selected date from date picker
                const datePicker = document.getElementById('order-date-picker');
                let selectedDate = null;
                if (datePicker && datePicker.value) {
                    selectedDate = new Date(datePicker.value);
                    console.log('üìÖ Using selected date:', selectedDate.toISOString().split('T')[0]);
                } else {
                    // Set default to today
                    selectedDate = new Date();
                    if (datePicker) {
                        datePicker.value = selectedDate.toISOString().split('T')[0];
                    }
                    console.log('üìÖ Using today as default:', selectedDate.toISOString().split('T')[0]);
                }
                
                let orders = [];
                
                if (useDummy) {
                    // Use dummy data - initialize OrderManager ONLY for demo
                    try {
                        if (!orderManager && typeof OrderManager !== 'undefined') {
                            orderManager = new OrderManager();
                            console.log('‚úÖ OrderManager initialized for demo data');
                        }
                        
                        if (orderManager) {
                            orders = await orderManager.fetchOrders(selectedDate, true);
                            console.log('‚úÖ Loaded demo data:', orders.length, 'orders');
                        } else {
                            throw new Error('OrderManager not available');
                        }
                    } catch (demoError) {
                        console.error('‚ùå Demo data failed:', demoError);
                        // Show error message
                        if (statusMsg) {
                            statusMsg.innerHTML = `<div style="color: #ef4444; padding: 16px;">Demo data failed to load. OrderManager not available.</div>`;
                            statusMsg.classList.add('show', 'error');
                        }
                        orders = [];
                    }
                } else {
                    // Fetch orders from API for the selected date
                    try {
                        console.log('üìÖ Fetching orders for date:', selectedDate.toISOString().split('T')[0]);
                        const apiOrders = await florinetAPI.fetchOrdersForDate(selectedDate);
                        if (apiOrders && apiOrders.length > 0) {
                            console.log('‚úÖ Loaded', apiOrders.length, 'raw orders from API');
                            
                            // VALIDATE ORDERS - filter out invalid/test/cancelled/duplicates
                            if (window.OrderValidator && typeof window.OrderValidator.validateOrders === 'function') {
                                const validationResult = window.OrderValidator.validateOrders(apiOrders);
                                orders = validationResult.orders;
                                
                                // Get statistics
                                const stats = window.OrderValidator.getOrderStats(orders);
                                console.log('');
                                console.log('üìä ORDER STATISTICS:');
                                console.log('  Aalsmeer:', stats.byRoute.Aalsmeer, 'orders');
                                console.log('  Naaldwijk:', stats.byRoute.Naaldwijk, 'orders');
                                console.log('  Rijnsburg:', stats.byRoute.Rijnsburg, 'orders');
                                console.log('  Total customers:', Object.keys(stats.byCustomer).length);
                                if (stats.topCustomers.length > 0) {
                                    console.log('  Top customer:', stats.topCustomers[0].name, `(${stats.topCustomers[0].count} orders)`);
                                }
                                console.log('');
                            } else {
                                // Fallback if validator not loaded
                                orders = apiOrders;
                                console.log('‚ö†Ô∏è Order validator not available, using all orders');
                            }
                            
                            console.log('‚úÖ Processing', orders.length, 'valid orders');
                            
                            // Initialize optimizer with orders that have carts assigned
                            console.log('üîß Initializing optimizer with', orders.length, 'orders...');
                            const optimizer = initializeOptimizer(orders);
                            const options = optimizer.generateOptions();
                            
                    // Update dashboard
                    updateDashboard(orders, options);
                    
                    // STORE IN GLOBAL STATE (handles localStorage automatically)
                    console.log(`üîÑ Saving ${orders.length} orders to global state...`);
                    window.appState.setOrders(orders, selectedDate);
                    
                    // Update debug panel
                    setTimeout(() => {
                        updateDebugPanel();
                    }, 100);
                    
                    // Clear previous truck assignments
                    localStorage.removeItem('zuidplas_route_truck_assignments');
                    console.log('üîÑ Cleared previous truck assignments - user must select fresh');
                        } else {
                            // No orders from API - this is OK, empty array is valid
                            console.log('‚ÑπÔ∏è No orders from API (empty array is normal)');
                            orders = [];
                        }
                    } catch (apiError) {
                        console.error('=================================');
                        console.error('‚ùå API FETCH FAILED - NO FALLBACK');
                        console.error('Error:', apiError);
                        console.error('=================================');
                        
                        // Show error to user - NO FALLBACK
                        if (statusMsg) {
                            statusMsg.innerHTML = `
                                <div style="padding: 16px; background: #fee2e2; border-left: 4px solid #ef4444; border-radius: 8px;">
                                    <strong style="color: #991b1b;">‚ùå API Connection Failed</strong><br>
                                    <small style="color: #7f1d1d;">${apiError.message}</small><br><br>
                                    <button onclick="manualRefresh()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px;">
                                        Retry Connection
                                    </button>
                                </div>
                            `;
                            statusMsg.classList.add('show', 'error');
                        }
                        
                        // Throw error - no fallback
                        throw apiError;
                    }
                }
                
                // Store flag for demo data
                if (useDummy) {
                    localStorage.setItem('zuidplas_using_demo_data', 'true');
                } else {
                    localStorage.setItem('zuidplas_using_demo_data', 'false');
                }
                
                // Initialize optimizer with orders
                console.log('üîß Initializing optimizer with', orders.length, 'orders...');
                const optimizer = initializeOptimizer(orders);
                
                // Generate options
                const options = optimizer.generateOptions();
                
                // Update dashboard
                updateDashboard(orders, options);
                
                // ‚úÖ SAVE TO GLOBAL STATE (for ALL data sources: API or Demo)
                console.log(`üîÑ Saving ${orders.length} orders to global state...`);
                window.appState.setOrders(orders, selectedDate);
                
                // Update debug panel
                setTimeout(() => {
                    updateDebugPanel();
                }, 100);
                
                syncBtn.innerHTML = useDummy ? '‚úÖ Demo Data Loaded' : '‚úÖ Synced';
                
                // Show status message
                if (statusMsg) {
                    if (useDummy) {
                        statusMsg.innerHTML = '‚úÖ Using demo data (20 sample orders)';
                        statusMsg.classList.add('show', 'success');
                    } else if (orders.length === 0) {
                        const dateStr = selectedDate ? selectedDate.toLocaleDateString() : 'today';
                        statusMsg.innerHTML = `‚ÑπÔ∏è No orders found for ${dateStr}. Try a different date or use demo data.`;
                        statusMsg.classList.add('show');
                    } else {
                        // Check if actually from API or demo data
                        const isDemoData = localStorage.getItem('zuidplas_using_demo_data') === 'true';
                        if (isDemoData) {
                            statusMsg.innerHTML = `‚úÖ Using demo data (${orders.length} sample orders)`;
                        } else {
                            statusMsg.innerHTML = `‚úÖ Found ${orders.length} orders from API`;
                        }
                        statusMsg.classList.add('show', 'success');
                    }
                }
                
                // Update last refreshed time
                updateLastRefreshed();
                updateLastUpdatedTime();
                
                if (syncBtn) {
                    setTimeout(() => {
                        syncBtn.innerHTML = originalText;
                        syncBtn.disabled = false;
                    }, 2000);
                }
                
            } catch (error) {
                syncBtn.innerHTML = '‚ùå Error';
                if (statusMsg) {
                    statusMsg.innerHTML = `‚ùå Error: ${error.message}. Try using demo data or check proxy server.`;
                    statusMsg.classList.add('show', 'error');
                }
                setTimeout(() => {
                    syncBtn.innerHTML = originalText;
                    syncBtn.disabled = false;
                }, 2000);
                console.error('Sync error:', error);
            }
        }

        // Load demo data button - make it global
        window.loadDemoData = function() {
            console.log('loadDemoData called');
            if (typeof window.syncOrders === 'function') {
                window.syncOrders(true);
            } else {
                console.error('window.syncOrders not available');
            }
        };

        // Update dashboard display
        function updateDashboard(orders, options) {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìä UPDATE DASHBOARD CALLED');
            console.log(`   Orders: ${orders.length}`);
            
            // Update stats
            document.getElementById('total-orders-count').textContent = orders.length;
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Use NEW CORRECT cart calculation (cart-calculation.js)
            if (typeof window.CartCalculation !== 'undefined') {
                console.log('üõí Using NEW cart-calculation.js (FUST-BASED with L11/L13)...');
                const cartResult = window.CartCalculation.calculateTotalCarts(orders);
                const totalCarts = cartResult.total || 0;
                
                console.log(`   Aalsmeer: ${cartResult.byRoute.Aalsmeer || 0} carts`);
                console.log(`   Naaldwijk: ${cartResult.byRoute.Naaldwijk || 0} carts`);
                console.log(`   Rijnsburg: ${cartResult.byRoute.Rijnsburg || 0} carts`);
                console.log(`   TOTAL: ${totalCarts} carts`);
                console.log(`   TRUCKS: ${cartResult.trucks || 0}`);
                
                document.getElementById('total-carts-needed').textContent = totalCarts;
                console.log(`‚úÖ Dashboard updated with CORRECT calculation: ${totalCarts} carts`);
            } else {
                console.error('‚ùå cart-calculation.js NOT LOADED! Using old buggy method...');
                const cartSummary = orderManager.getCartSummary();
                const totalCarts = (cartSummary.standard || 0) + (cartSummary.danish || 0);
                document.getElementById('total-carts-needed').textContent = totalCarts;
                console.log(`‚ö†Ô∏è Dashboard (OLD BUGGY METHOD): ${totalCarts} carts`);
            }
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Update routes status
            try {
                // Use orders directly (they already have all data)
                const ordersWithCarts = orders || [];
                console.log('üìä Updating routes status with', ordersWithCarts.length, 'orders');
                const optimizer = initializeOptimizer(ordersWithCarts);
                const routeAnalysis = optimizer.processOrders();
                const routesWithOrders = Object.keys(routeAnalysis).filter(routeKey => {
                    const analysis = routeAnalysis[routeKey];
                    return analysis && analysis.orders && analysis.orders.length > 0;
                }).length;
                document.getElementById('routes-status').textContent = `${routesWithOrders}/3`;
            } catch (error) {
                console.error('Error updating routes status:', error);
                document.getElementById('routes-status').textContent = '0/3';
            }
            
            // Update routes
            updateRouteOverview(orders, options);
            
            // Update optimization suggestions
            updateOptimizationSuggestions(options);
            
            // Update optimization score
            if (options.length > 0) {
                const bestOption = options[0];
                document.getElementById('optimization-score').textContent = bestOption.score + '%';
            }
        }

        // Update route overview
        function updateRouteOverview(orders, options) {
            const container = document.getElementById('route-overview');
            if (!container) return;
            
            container.innerHTML = '';
            
            try {
                // Use orders directly (they already have all data)
                const ordersWithCarts = orders || [];
                console.log('üìä Updating route overview with', ordersWithCarts.length, 'orders');
                const optimizer = initializeOptimizer(ordersWithCarts);
                const routeAnalysis = optimizer.processOrders();
                
                Object.keys(ROUTES).forEach(routeKey => {
                    const route = ROUTES[routeKey];
                    const analysis = routeAnalysis[routeKey];
                    
                    // Always show all routes, even if empty
                    if (!analysis) {
                        console.warn(`No analysis for route ${routeKey}, creating empty structure`);
                        // Create empty route card
                        const emptyCard = document.createElement('div');
                        emptyCard.className = 'route-card';
                        emptyCard.innerHTML = `
                            <div class="route-header">
                                <div class="route-title">Route ${route.id}: ${route.name}</div>
                                <div class="route-time">${route.departureTime}</div>
                            </div>
                            <div class="route-info">
                                <div class="route-info-item">
                                    <div class="route-info-label">${typeof i18n !== 'undefined' ? i18n.t('optimization.orders', 'Orders') : 'Orders'}</div>
                                    <div class="route-info-value">0</div>
                                </div>
                                <div class="route-info-item">
                                    <div class="route-info-label">${typeof i18n !== 'undefined' ? i18n.t('optimization.cartsNeeded', 'Carts Needed') : 'Carts Needed'}</div>
                                    <div class="route-info-value">0 / 17</div>
                                </div>
                                <div class="route-info-item">
                                    <div class="route-info-label">${typeof i18n !== 'undefined' ? i18n.t('optimization.status', 'Status') : 'Status'}</div>
                                    <div class="route-info-value"><span class="badge success">${typeof i18n !== 'undefined' ? i18n.t('common.ready', 'Ready') : 'Ready'}</span></div>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 0%; background: var(--success)"></div>
                            </div>
                        `;
                        container.appendChild(emptyCard);
                        return;
                    }
                    
                    // Use capacity object if available, otherwise use direct properties
                    const capacity = analysis.capacity || {
                        fits: analysis.fits !== undefined ? analysis.fits : true,
                        status: analysis.status || 'fits',
                        maxCapacity: analysis.maxCapacity || 17,
                        equivalentStandard: analysis.totalCarts || 0,
                        utilization: analysis.utilization || 0,
                        overflow: analysis.overflow || 0
                    };
                const statusClass = capacity.fits ? 'success' : capacity.status === 'tight' ? 'warning' : 'danger';
                let statusText = '';
                if (typeof i18n !== 'undefined') {
                    statusText = capacity.fits ? i18n.t('common.ready', 'Ready') : capacity.status === 'tight' ? i18n.t('common.tight', 'Tight') : i18n.t('optimization.overflow', 'Overflow');
                } else {
                    statusText = capacity.fits ? 'Ready' : capacity.status === 'tight' ? 'Tight' : 'Overflow';
                }
                
                const progress = Math.min(100, parseFloat(capacity.utilization));
                
                const card = document.createElement('div');
                card.className = 'route-card';
                card.innerHTML = `
                    <div class="route-header">
                        <div class="route-title">Route ${route.id}: ${route.name}</div>
                        <div class="route-time">${route.departureTime}</div>
                    </div>
                    <div class="route-info">
                        <div class="route-info-item">
                            <div class="route-info-label">${typeof i18n !== 'undefined' ? i18n.t('optimization.orders', 'Orders') : 'Orders'}</div>
                            <div class="route-info-value">${analysis.orders.length}</div>
                        </div>
                        <div class="route-info-item">
                            <div class="route-info-label">${typeof i18n !== 'undefined' ? i18n.t('optimization.cartsNeeded', 'Carts Needed') : 'Carts Needed'}</div>
                            <div class="route-info-value">${capacity.equivalentStandard} / ${capacity.maxCapacity}</div>
                        </div>
                        <div class="route-info-item">
                            <div class="route-info-label">${typeof i18n !== 'undefined' ? i18n.t('optimization.status', 'Status') : 'Status'}</div>
                            <div class="route-info-value"><span class="badge ${statusClass}">${statusText}</span></div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%; background: ${progress >= 100 ? 'var(--danger)' : progress >= 80 ? 'var(--warning)' : 'var(--success)'}"></div>
                    </div>
                    ${capacity.warning ? `<div class="info-box warning" style="margin-top: 15px;">${capacity.warning}</div>` : ''}
                    <div class="route-actions">
                        <a href="optimization.html" class="btn btn-primary">${typeof i18n !== 'undefined' ? i18n.t('optimization.runOptimization', 'Optimize') : 'Optimize'}</a>
                        <a href="orders.html" class="btn btn-secondary">${typeof i18n !== 'undefined' ? i18n.t('common.viewDetails', 'View Details') : 'View Details'}</a>
                    </div>
                `;
                
                container.appendChild(card);
            });
            } catch (error) {
                console.error('Error updating route overview:', error);
                container.innerHTML = `<div class="info-box danger">Error loading route data: ${error.message}</div>`;
            }
        }

        // Update optimization suggestions
        function updateOptimizationSuggestions(options) {
            const container = document.getElementById('optimization-suggestions');
            if (!container || options.length === 0) {
                // Show default message with translation
                const defaultMsg = typeof i18n !== 'undefined' ? i18n.t('dashboard.clickToSync') : 'Click "Sync Orders from API" to fetch real orders, or "Load Demo Data" to test with sample orders';
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--text-secondary);">${defaultMsg}</div>`;
                return;
            }
            
            const bestOption = options[0];
            const recommendedText = typeof i18n !== 'undefined' ? i18n.t('optimization.recommended', 'Recommended') : 'Recommended';
            const totalCostText = typeof i18n !== 'undefined' ? i18n.t('costs.total', 'Total Cost') : 'Total Cost';
            const feasibilityText = typeof i18n !== 'undefined' ? i18n.t('common.feasibility', 'Feasibility') : 'Feasibility';
            const allFitsText = typeof i18n !== 'undefined' ? i18n.t('optimization.allFits', 'All fits') : 'All fits';
            const overflowText = typeof i18n !== 'undefined' ? i18n.t('optimization.overflow', 'Overflow detected') : 'Overflow detected';
            const scoreText = typeof i18n !== 'undefined' ? i18n.t('optimization.optimizationScore', 'Score') : 'Score';
            
            container.innerHTML = `
                <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">‚≠ê ${recommendedText}: ${bestOption.name}</h3>
                    <p style="margin-bottom: 15px;">${bestOption.description}</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div><strong>${totalCostText}:</strong> ‚Ç¨${bestOption.cost}</div>
                        <div><strong>${feasibilityText}:</strong> <span class="badge ${bestOption.feasibility.fits ? 'success' : 'danger'}">${bestOption.feasibility.fits ? allFitsText : overflowText}</span></div>
                        <div><strong>${scoreText}:</strong> ${bestOption.score}%</div>
                    </div>
                    ${bestOption.requiresAction ? `<div class="info-box warning">${bestOption.requiresAction}</div>` : ''}
                    <div style="margin-top: 15px;">
                        <a href="optimization.html" class="btn btn-primary">${typeof i18n !== 'undefined' ? i18n.t('optimization.optimizationOptions', 'View All Options') : 'View All Options'}</a>
                    </div>
                </div>
                
                ${options.length > 1 ? `
                <div style="margin-top: 20px;">
                    <h4>${typeof i18n !== 'undefined' ? i18n.t('optimization.alternative', 'Alternative Options') + ':' : 'Alternative Options:'}</h4>
                    <div style="display: grid; gap: 15px; margin-top: 15px;">
                        ${options.slice(1, 4).map(option => `
                            <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${option.name}</strong>
                                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;">
                                            Cost: ‚Ç¨${option.cost} | Score: ${option.score}%
                                        </div>
                                    </div>
                                    <a href="optimization.html" class="btn btn-secondary" style="padding: 8px 16px;">${typeof i18n !== 'undefined' ? i18n.t('common.view', 'View') : 'View'}</a>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;
        }

        // Toggle sidebar collapse (desktop)
        function toggleSidebarCollapse() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            // Save state
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        }
        
        // Toggle sidebar on mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('open') && 
                !sidebar.contains(event.target) && 
                !menuBtn.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });
        
        // Restore sidebar state on load
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed && window.innerWidth > 768) {
                sidebar.classList.add('collapsed');
            }
        });
        
        // Language switcher - GLOBAL and PERSISTENT across ALL pages
        window.setLanguage = function(lang) {
            // CRITICAL: Save to localStorage FIRST - this makes it global
            localStorage.setItem('zuidplas_language', lang);
            
            // Update current page immediately
            if (typeof i18n !== 'undefined') {
                i18n.currentLang = lang;
                i18n.setLanguage(lang);
                i18n.updatePage();
                updateLanguageButtons();
            }
            
            // Dispatch storage event so other pages can detect the change
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'zuidplas_language',
                newValue: lang,
                oldValue: localStorage.getItem('zuidplas_user_language') || localStorage.getItem('zuidplas_language')
            }));
        };
        
        // Language buttons removed - language set at login only
        
        // Check if user needs to login (first time)
        function checkLogin() {
            const loggedIn = localStorage.getItem('zuidplas_logged_in');
            const currentPage = window.location.pathname;
            
            // Don't redirect if already on login page
            if (currentPage.includes('login.html')) {
                return;
            }
            
            // If not logged in and not in demo mode, redirect to login
            if (!loggedIn && !localStorage.getItem('zuidplas_demo_mode')) {
                // Check if user wants to skip login (demo mode)
                const skipLogin = sessionStorage.getItem('skip_login');
                if (!skipLogin) {
                    window.location.href = 'login.html';
                }
            }
        }
        
        // Auto-sync on load (optional)
        document.addEventListener('DOMContentLoaded', async () => {
            // Check login status
            checkLogin();
            
            // Load language from user session (set at login)
            setTimeout(() => {
                if (typeof i18n !== 'undefined') {
                    const userLang = localStorage.getItem('zuidplas_user_language') || 
                                     localStorage.getItem('zuidplas_user_language') || localStorage.getItem('zuidplas_language') || 
                                     'nl';
                    i18n.setLanguage(userLang);
                    i18n.updatePage();
                }
            }, 100);
            
            // Wait a bit for auth to complete
            setTimeout(async () => {
                try {
                    // Check authentication status
                    const token = await authManager.getValidToken();
                    if (token) {
                        console.log('‚úÖ Authentication ready');
                    }
                    
                    // No auto-refresh - user must click refresh button manually
                    console.log('‚úÖ Page loaded - use Refresh Data button to load orders');
                } catch (error) {
                    console.error('Initial load error:', error);
                }
            }, 1500);
        });
    
        // Logout function - MUST BE GLOBAL
        function handleLogout() {
            const confirmMsg = typeof i18n !== 'undefined' 
                ? i18n.t('common.confirmLogout', 'Are you sure you want to logout?') 
                : 'Are you sure you want to logout?';
            
            if (confirm(confirmMsg)) {
                // Clear all session data
                localStorage.removeItem('zuidplas_logged_in');
                localStorage.removeItem('florinet_token');
                localStorage.removeItem('florinet_token_expiry');
                localStorage.removeItem('florinet_username');
                localStorage.removeItem('florinet_password');
                localStorage.removeItem('zuidplas_demo_mode');
                sessionStorage.clear();
                
                // Redirect to login
                window.location.href = 'login.html';
            }
        }
        
        // Make logout function global - CRITICAL!
        window.handleLogout = handleLogout;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DEBUG STATE CHECKER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function debugCheckState() {
            const globalCount = window.appState?.getOrderCount() || 0;
            
            // Check BOTH old and new localStorage keys
            const oldData = localStorage.getItem('cachedOrders');
            const newData = localStorage.getItem('zuidplas_orders');
            const oldCount = oldData ? JSON.parse(oldData).length : 0;
            const newCount = newData ? JSON.parse(newData).length : 0;
            
            const lastSync = localStorage.getItem('lastSyncDate') || 'Never';
            const currentDate = window.appState?.currentDate || '-';
            
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üêõ DEBUG STATE CHECK (DASHBOARD)');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log(`Global State (memory): ${globalCount} orders`);
            console.log(`OLD LocalStorage (cachedOrders): ${oldCount} orders`);
            console.log(`NEW LocalStorage (zuidplas_orders): ${newCount} orders`);
            console.log(`Last Sync: ${lastSync}`);
            console.log(`Current Date: ${currentDate}`);
            console.log('window.appState:', window.appState);
            console.log('Sample order:', window.appState?.orders?.[0]);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            alert(`üêõ DASHBOARD STATE\n\nMemory: ${globalCount} orders\nOLD storage: ${oldCount} orders\nNEW storage: ${newCount} orders\nLast sync: ${lastSync}\nDate: ${currentDate}`);
        }
        
        // Update debug panel every 2 seconds
        function updateDebugPanel() {
            const globalCount = window.appState?.getOrderCount() || 0;
            
            // Check BOTH old and new localStorage keys
            const oldData = localStorage.getItem('cachedOrders');
            const newData = localStorage.getItem('zuidplas_orders');
            const localCount = newData ? JSON.parse(newData).length : (oldData ? JSON.parse(oldData).length : 0);
            
            const lastSync = localStorage.getItem('lastSyncDate') || 'Never';
            const currentDate = window.appState?.currentDate || '-';
            
            const globalEl = document.getElementById('debug-global-orders');
            const localEl = document.getElementById('debug-local-orders');
            const syncEl = document.getElementById('debug-last-sync');
            const dateEl = document.getElementById('debug-current-date');
            
            if (globalEl) globalEl.textContent = globalCount;
            if (localEl) localEl.textContent = localCount;
            if (syncEl) syncEl.textContent = lastSync === 'Never' ? 'Never' : new Date(lastSync).toLocaleTimeString();
            if (dateEl) dateEl.textContent = currentDate;
        }
        
        // Make functions global
        window.debugCheckState = debugCheckState;
        window.updateDebugPanel = updateDebugPanel;
        
        // Listen for orders updated event and update debug panel immediately
        window.addEventListener('ordersUpdated', (event) => {
            console.log('üì¢ Debug panel: Orders updated event received:', event.detail.count);
            updateDebugPanel();
        });
        
        // Update debug panel periodically
        setInterval(updateDebugPanel, 2000);
        
        // Initial update
        setTimeout(updateDebugPanel, 1000);

    </script>
</body>
</html>
