<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart Loading Optimizer - Zuidplas Logistics</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .truck-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        
        .truck-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .truck-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }
        
        .truck-slots {
            display: grid;
            grid-template-columns: repeat(17, 1fr);
            gap: 8px;
            margin: 20px 0;
        }
        
        .cart-slot {
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            position: relative;
            transition: all 0.2s;
        }
        
        .cart-slot.filled-standard {
            color: white;
            border-width: 2px;
            font-weight: 600;
        }
        
        .cart-slot.filled-danish {
            color: white;
            border-width: 3px;
            font-weight: 600;
        }
        
        .client-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .client-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .client-color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .cart-visualization {
            margin-top: 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .cart-visual-item {
            display: inline-block;
            margin: 4px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            color: white;
            border: 2px solid rgba(0,0,0,0.1);
        }
        
        .cart-slot.empty {
            background: #f9fafb;
            color: var(--text-secondary);
            border-style: dashed;
        }
        
        .cart-slot.overflow {
            background: #fee2e2;
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .route-assignment {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .route-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }
        
        .route-rijnsburg { background: #dbeafe; color: #1e40af; }
        .route-aalsmeer { background: #dcfce7; color: #166534; }
        .route-naaldwijk { background: #fef3c7; color: #92400e; }
        
        .cart-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .cart-item.standard { border-left-color: #3b82f6; }
        .cart-item.danish { border-left-color: #8b5cf6; }
        
        .capacity-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .capacity-bar {
            flex: 1;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .capacity-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s;
        }
        
        .capacity-fill.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }
        
        .capacity-fill.danger {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <button class="sidebar-close" onclick="toggleSidebar()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>

        <div class="sidebar-logo">
            <svg width="32" height="32" viewBox="0 0 32 32">
                <rect x="4" y="8" width="24" height="16" rx="2" fill="#f97316"/>
                <rect x="6" y="12" width="8" height="8" fill="#fff"/>
                <rect x="18" y="12" width="8" height="8" fill="#fff"/>
            </svg>
            <span>Zuidplas</span>
        </div>

        <button class="sidebar-toggle" onclick="toggleSidebarCollapse()" title="Collapse sidebar">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>

        <nav class="sidebar-nav">
            <a href="index.html" class="nav-link">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                <span data-i18n="nav.dashboard">Dashboard</span>
            </a>
            
            <a href="orders.html" class="nav-link">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                </svg>
                <span data-i18n="nav.orders">Orders</span>
            </a>
            
            <a href="optimization.html" class="nav-link">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polyline>
                </svg>
                <span data-i18n="nav.optimization">Optimization</span>
            </a>
            
            <a href="trucks.html" class="nav-link">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="3" width="15" height="13"></rect>
                    <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                </svg>
                <span data-i18n="nav.trucks">Trucks</span>
            </a>
            
            <a href="cart-loading.html" class="nav-link active">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="7" width="20" height="14" rx="2"></rect>
                    <path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"></path>
                    <line x1="12" y1="12" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="8" y2="16"></line>
                    <line x1="16" y1="12" x2="16" y2="16"></line>
                </svg>
                <span data-i18n="nav.cartOptimization">Cart Optimization</span>
            </a>
            
            <a href="costs.html" class="nav-link">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
                <span data-i18n="nav.costs">Costs</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div id="auth-status" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 12px;"></div>
            <button onclick="handleLogout()" class="logout-btn" data-i18n="common.logout">üö™ Uitloggen</button>
        </div>
    </aside>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title" data-i18n="cartLoading.title">Cart Optimization</h1>
            <p class="page-subtitle" data-i18n="cartLoading.subtitle">Place all carts on 2 trucks - Cover all 3 routes efficiently</p>
            <button class="btn btn-primary" onclick="optimizeCartLoading()" style="margin-top: 20px;" data-i18n="cartLoading.optimizeButton">üîÑ Optimize Cart Loading</button>
        </div>

        <!-- Summary Stats -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="icon">üì¶</div>
                <div class="label" data-i18n="cartLoading.totalCarts">Total Carts</div>
                <div class="value" id="total-carts">0</div>
            </div>
            <div class="stat-card success">
                <div class="icon">‚úÖ</div>
                <div class="label" data-i18n="cartLoading.cartsAssigned">Carts Assigned</div>
                <div class="value" id="carts-assigned">0</div>
            </div>
            <div class="stat-card warning">
                <div class="icon">‚ö†Ô∏è</div>
                <div class="label" data-i18n="cartLoading.overflow">Overflow</div>
                <div class="value" id="overflow-count">0</div>
            </div>
            <div class="stat-card info">
                <div class="icon">üéØ</div>
                <div class="label" data-i18n="cartLoading.routesCovered">Routes Covered</div>
                <div class="value" id="routes-covered">0/3</div>
            </div>
        </div>

        <!-- Truck Loading Visualization -->
        <div class="truck-container" id="truck-container">
            <!-- Populated by JavaScript -->
        </div>

        <!-- Cart List by Route -->
        <div class="card">
            <h2 data-i18n="cartLoading.cartsByRoute">Carts by Route</h2>
            <div id="cart-list-by-route">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- LANGUAGE SCRIPTS - MUST BE FIRST -->
    <script src="js/i18n.js"></script>
    <script src="js/i18n-init.js"></script>
    
    <!-- PAGE-SPECIFIC SCRIPTS -->
    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/carts.js"></script>
    <script src="js/orders.js"></script>
    <script src="js/optimizer.js"></script>
    <script src="js/navigation.js"></script>
    <script>
        let cartLoadingOptimizer = null;

        class CartLoadingOptimizer {
            constructor(orders) {
                this.orders = orders || [];
                this.cartManager = cartManager;
                this.truckAssignments = {
                    truck1: { carts: [], routes: [], danishCount: 0, standardCount: 0 },
                    truck2: { carts: [], routes: [], danishCount: 0, standardCount: 0 }
                };
            }

            /**
             * Get all carts that need to be loaded
             */
            getAllCarts() {
                const ordersWithCarts = this.orders.map(order => 
                    this.cartManager.assignCartType(order)
                );
                
                // Group by client (same client = same cart)
                const ordersByClient = {};
                ordersWithCarts.forEach(order => {
                    const clientName = order.customer || order.customerName || 'Unknown';
                    if (!ordersByClient[clientName]) {
                        ordersByClient[clientName] = [];
                    }
                    ordersByClient[clientName].push(order);
                });

                const allCarts = [];
                Object.keys(ordersByClient).forEach(clientName => {
                    const clientOrders = ordersByClient[clientName];
                    const route = this.cartManager.determineRoute(clientOrders[0]);
                    
                    // Assign cart type to all orders from this client
                    const ordersWithCartType = clientOrders.map(order => 
                        this.cartManager.assignCartType(order)
                    );
                    const cartType = ordersWithCartType[0].cartType;
                    
                    // CRITICAL: Distribute orders across carts properly
                    // Each cart should only contain orders that fit in that cart
                    let currentCartOrders = [];
                    let currentCartCapacity = 0;
                    let cartIndex = 1;
                    const cartCapacity = cartType === 'danish' 
                        ? this.cartManager.capacities.danish 
                        : this.cartManager.capacities.standard[ordersWithCartType[0].crateType || '612'] || 72;
                    
                    ordersWithCartType.forEach(order => {
                        const quantity = order.quantity || order.amount || 0;
                        
                        // If this order fits in current cart
                        if (currentCartCapacity + quantity <= cartCapacity) {
                            currentCartOrders.push(order);
                            currentCartCapacity += quantity;
                        } else {
                            // Current cart is full, create it and start new cart
                            if (currentCartOrders.length > 0) {
                                allCarts.push({
                                    id: `cart-${clientName}-${cartIndex}`,
                                    client: clientName,
                                    route: route,
                                    type: cartType,
                                    orders: [...currentCartOrders], // Copy array
                                    cartNumber: cartIndex,
                                    totalCarts: 0, // Will be calculated
                                    capacity: cartCapacity,
                                    usedCapacity: currentCartCapacity
                                });
                                cartIndex++;
                            }
                            
                            // Start new cart with this order
                            currentCartOrders = [order];
                            currentCartCapacity = quantity;
                            
                            // If single order exceeds cart capacity, split it
                            if (quantity > cartCapacity) {
                                const fullCarts = Math.floor(quantity / cartCapacity);
                                const remainder = quantity % cartCapacity;
                                
                                // Create full carts
                                for (let i = 0; i < fullCarts; i++) {
                                    allCarts.push({
                                        id: `cart-${clientName}-${cartIndex}`,
                                        client: clientName,
                                        route: route,
                                        type: cartType,
                                        orders: [{...order, quantity: cartCapacity}],
                                        cartNumber: cartIndex,
                                        totalCarts: 0,
                                        capacity: cartCapacity,
                                        usedCapacity: cartCapacity
                                    });
                                    cartIndex++;
                                }
                                
                                // Handle remainder
                                if (remainder > 0) {
                                    currentCartOrders = [{...order, quantity: remainder}];
                                    currentCartCapacity = remainder;
                                } else {
                                    currentCartOrders = [];
                                    currentCartCapacity = 0;
                                }
                            }
                        }
                    });
                    
                    // Don't forget the last cart
                    if (currentCartOrders.length > 0) {
                        allCarts.push({
                            id: `cart-${clientName}-${cartIndex}`,
                            client: clientName,
                            route: route,
                            type: cartType,
                            orders: currentCartOrders,
                            cartNumber: cartIndex,
                            totalCarts: 0,
                            capacity: cartCapacity,
                            usedCapacity: currentCartCapacity
                        });
                    }
                    
                    // Update totalCarts for all carts from this client
                    const clientCarts = allCarts.filter(c => c.client === clientName);
                    clientCarts.forEach(cart => {
                        cart.totalCarts = clientCarts.length;
                    });
                });

                return allCarts;
            }

            /**
             * Optimize cart assignment to trucks
             */
            optimizeAssignment() {
                const allCarts = this.getAllCarts();
                
                // Reset assignments
                this.truckAssignments = {
                    truck1: { carts: [], routes: new Set(), danishCount: 0, standardCount: 0 },
                    truck2: { carts: [], routes: new Set(), danishCount: 0, standardCount: 0 }
                };

                // Group carts by route
                const cartsByRoute = {
                    rijnsburg: [],
                    aalsmeer: [],
                    naaldwijk: []
                };

                allCarts.forEach(cart => {
                    if (cartsByRoute[cart.route]) {
                        cartsByRoute[cart.route].push(cart);
                    }
                });

                // Strategy: 
                // Truck 1: Route 1 (Rijnsburg) + Route 3 (Naaldwijk)
                // Truck 2: Route 2 (Aalsmeer)

                // Assign Route 1 carts to Truck 1
                cartsByRoute.rijnsburg.forEach(cart => {
                    this.assignCartToTruck(cart, 'truck1');
                });

                // Assign Route 2 carts to Truck 2
                cartsByRoute.aalsmeer.forEach(cart => {
                    this.assignCartToTruck(cart, 'truck2');
                });

                // Assign Route 3 carts to Truck 1 (if fits, otherwise Truck 2)
                cartsByRoute.naaldwijk.forEach(cart => {
                    if (this.canFitInTruck(cart, 'truck1')) {
                        this.assignCartToTruck(cart, 'truck1');
                    } else if (this.canFitInTruck(cart, 'truck2')) {
                        this.assignCartToTruck(cart, 'truck2');
                    } else {
                        // Overflow - mark it
                        cart.overflow = true;
                        this.assignCartToTruck(cart, 'truck1'); // Assign anyway for visualization
                    }
                });

                return {
                    truck1: this.truckAssignments.truck1,
                    truck2: this.truckAssignments.truck2,
                    allCarts: allCarts
                };
            }

            assignCartToTruck(cart, truckId) {
                const truck = this.truckAssignments[truckId];
                truck.carts.push(cart);
                truck.routes.add(cart.route);
                
                if (cart.type === 'danish') {
                    truck.danishCount++;
                } else {
                    truck.standardCount++;
                }
            }

            canFitInTruck(cart, truckId) {
                const truck = this.truckAssignments[truckId];
                const currentDanish = truck.danishCount + (cart.type === 'danish' ? 1 : 0);
                const currentStandard = truck.standardCount + (cart.type === 'standard' ? 1 : 0);
                
                const maxCapacity = currentDanish > BUSINESS_RULES.danishThreshold 
                    ? BUSINESS_RULES.maxCartsWithDanish 
                    : BUSINESS_RULES.maxStandardCarts;
                
                const equivalentStandard = currentStandard + Math.ceil(currentDanish / BUSINESS_RULES.danishToStandardRatio);
                
                return equivalentStandard <= maxCapacity;
            }

            getTruckCapacity(truckId) {
                const truck = this.truckAssignments[truckId];
                const maxCapacity = truck.danishCount > BUSINESS_RULES.danishThreshold 
                    ? BUSINESS_RULES.maxCartsWithDanish 
                    : BUSINESS_RULES.maxStandardCarts;
                
                const equivalentStandard = truck.standardCount + Math.ceil(truck.danishCount / BUSINESS_RULES.danishToStandardRatio);
                
                return {
                    max: maxCapacity,
                    used: equivalentStandard,
                    standard: truck.standardCount,
                    danish: truck.danishCount,
                    fits: equivalentStandard <= maxCapacity,
                    overflow: Math.max(0, equivalentStandard - maxCapacity),
                    utilization: ((equivalentStandard / maxCapacity) * 100).toFixed(1)
                };
            }
        }

        function optimizeCartLoading() {
            // Try to load orders from storage if not in memory
            if (!orderManager || !orderManager.orders || orderManager.orders.length === 0) {
                // Try loading from localStorage
                const loaded = orderManager.loadOrdersFromStorage();
                
                // If still no orders, try loading demo data automatically
                if (!loaded || !orderManager.orders || orderManager.orders.length === 0) {
                    console.log('üì¶ No orders found, loading demo data automatically...');
                    orderManager.fetchOrders(null, true).then(() => {
                        // Retry optimization after loading
                        if (orderManager.orders && orderManager.orders.length > 0) {
                            cartLoadingOptimizer = new CartLoadingOptimizer(orderManager.orders);
                            const result = cartLoadingOptimizer.optimizeAssignment();
                            updateTruckVisualization(result);
                            updateCartList(result.allCarts);
                            updateSummaryStats(result);
                        }
                    }).catch(err => {
                        console.error('Error loading demo data:', err);
                        alert('Please load orders first from Dashboard, or enable demo data.');
                    });
                    return;
                }
            }

            cartLoadingOptimizer = new CartLoadingOptimizer(orderManager.orders);
            const result = cartLoadingOptimizer.optimizeAssignment();
            
            updateTruckVisualization(result);
            updateCartList(result.allCarts);
            updateSummaryStats(result);
        }

        function updateTruckVisualization(result) {
            const container = document.getElementById('truck-container');
            container.innerHTML = '';

            // Truck 1
            const truck1Capacity = cartLoadingOptimizer.getTruckCapacity('truck1');
            const truck1Name = typeof i18n !== 'undefined' ? `${i18n.t('cartLoading.truck1', 'Truck 1')}` : 'Truck 1';
            const truck1Card = createTruckCard(truck1Name, result.truck1, truck1Capacity, ['rijnsburg', 'naaldwijk']);
            container.appendChild(truck1Card);

            // Truck 2
            const truck2Capacity = cartLoadingOptimizer.getTruckCapacity('truck2');
            const truck2Name = typeof i18n !== 'undefined' ? `${i18n.t('cartLoading.truck2', 'Truck 2')}` : 'Truck 2';
            const truck2Card = createTruckCard(truck2Name, result.truck2, truck2Capacity, ['aalsmeer']);
            container.appendChild(truck2Card);
        }

        // Generate unique color for each client
        function getClientColor(clientName, clientIndex) {
            const colors = [
                '#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444',
                '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1',
                '#14b8a6', '#a855f7', '#22c55e', '#eab308', '#f43f5e'
            ];
            return colors[clientIndex % colors.length];
        }

        function createTruckCard(truckName, truckData, capacity, expectedRoutes) {
            const card = document.createElement('div');
            card.className = 'truck-card';
            
            const routes = Array.from(truckData.routes);
            const statusClass = capacity.fits ? 'success' : 'danger';
            const statusIcon = capacity.fits ? '‚úÖ' : '‚ùå';
            
            // Get all unique clients from carts
            const clients = [...new Set(truckData.carts.map(cart => cart.client || 'Unknown'))];
            const clientColorMap = {};
            clients.forEach((client, index) => {
                clientColorMap[client] = getClientColor(client, index);
            });
            
            // Create cart slots with client information
            const slots = [];
            let slotIndex = 0;
            
            // Process each cart with client info
            truckData.carts.forEach(cart => {
                if (slotIndex < capacity.max) {
                    const clientColor = clientColorMap[cart.client || 'Unknown'];
                    slots.push({ 
                        type: cart.type, 
                        index: slotIndex,
                        client: cart.client || 'Unknown',
                        color: clientColor,
                        route: cart.route
                    });
                    slotIndex++;
                }
            });
            
            // Fill remaining slots as empty
            while (slotIndex < capacity.max) {
                slots.push({ type: 'empty', index: slotIndex });
                slotIndex++;
            }
            
            // Add overflow slots if needed
            if (capacity.overflow > 0) {
                for (let i = 0; i < capacity.overflow; i++) {
                    slots.push({ type: 'overflow', index: slotIndex });
                    slotIndex++;
                }
            }

            card.innerHTML = `
                <div class="truck-header">
                    <div>
                        <h2 style="margin: 0;">${truckName}</h2>
                        <div style="margin-top: 8px;">
                            <span class="badge ${statusClass}">${statusIcon} ${capacity.fits ? (typeof i18n !== 'undefined' ? i18n.t('status.fits', 'Fits') : 'Fits') : (typeof i18n !== 'undefined' ? i18n.t('status.overflow', 'Overflow') : 'Overflow')}</span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">
                            ${capacity.used} / ${capacity.max}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            ${capacity.utilization}% ${typeof i18n !== 'undefined' ? i18n.t('status.utilized', 'utilized') : 'utilized'}
                        </div>
                    </div>
                </div>

                <div class="truck-slots">
                    ${slots.map(slot => {
                        if (slot.type === 'standard') {
                            const clientInitial = slot.client ? slot.client.charAt(0).toUpperCase() : 'S';
                            const standardCartText = typeof i18n !== 'undefined' ? i18n.t('cartLoading.standardCart', 'Standard Cart') : 'Standard Cart';
                            const unknownText = typeof i18n !== 'undefined' ? i18n.t('common.unknown', 'Unknown') : 'Unknown';
                            return `<div class="cart-slot filled-standard" 
                                     style="background: ${slot.color || '#3b82f6'}; border-color: ${slot.color || '#3b82f6'};" 
                                     title="${standardCartText} - ${slot.client || unknownText}">${clientInitial}</div>`;
                        } else if (slot.type === 'danish') {
                            const clientInitial = slot.client ? slot.client.charAt(0).toUpperCase() : 'D';
                            const danishCartText = typeof i18n !== 'undefined' ? i18n.t('cartLoading.danishCart', 'Danish Cart') : 'Danish Cart';
                            const unknownText = typeof i18n !== 'undefined' ? i18n.t('common.unknown', 'Unknown') : 'Unknown';
                            return `<div class="cart-slot filled-danish" 
                                     style="background: ${slot.color || '#8b5cf6'}; border-color: ${slot.color || '#8b5cf6'};" 
                                     title="${danishCartText} - ${slot.client || unknownText}">${clientInitial}</div>`;
                        } else if (slot.type === 'overflow') {
                            const overflowText = typeof i18n !== 'undefined' ? i18n.t('status.overflow', 'Overflow') : 'Overflow';
                            return `<div class="cart-slot overflow" title="${overflowText}">!</div>`;
                        } else {
                            return '<div class="cart-slot empty" title="Empty"></div>';
                        }
                    }).join('')}
                </div>
                
                ${clients.length > 0 ? `
                <div class="client-legend">
                    <strong style="width: 100%; margin-bottom: 8px; display: block;">${typeof i18n !== 'undefined' ? i18n.t('cartLoading.clientColors', 'Client Colors') : 'Client Colors'}:</strong>
                    ${clients.map(client => {
                        const color = clientColorMap[client];
                        return `
                            <div class="client-legend-item">
                                <div class="client-color-box" style="background: ${color};"></div>
                                <span>${client}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
                ` : ''}

                <div class="capacity-indicator">
                    <div class="capacity-bar">
                        <div class="capacity-fill ${capacity.utilization > 90 ? 'danger' : capacity.utilization > 75 ? 'warning' : ''}" 
                             style="width: ${capacity.utilization}%"></div>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        ${capacity.standard} ${capacity.standard === 1 
                            ? (typeof i18n !== 'undefined' ? i18n.t('cartLoading.standardCart', 'Standard Cart') : 'Standard Cart')
                            : (typeof i18n !== 'undefined' ? i18n.t('cartLoading.standardCarts', 'Standard Carts') : 'Standard Carts')} + 
                        ${capacity.danish} ${capacity.danish === 1 
                            ? (typeof i18n !== 'undefined' ? i18n.t('cartLoading.danishCart', 'Danish Cart') : 'Danish Cart')
                            : (typeof i18n !== 'undefined' ? i18n.t('cartLoading.danishCarts', 'Danish Carts') : 'Danish Carts')}
                    </div>
                </div>

                <div class="route-assignment">
                    <strong>Routes:</strong>
                    ${routes.map(route => {
                        const routeName = route === 'rijnsburg' ? 'Rijnsburg (09:00)' :
                                         route === 'aalsmeer' ? 'Aalsmeer (10:00)' :
                                         route === 'naaldwijk' ? 'Naaldwijk (11:00)' : route;
                        const routeClass = `route-${route}`;
                        return `<span class="route-badge ${routeClass}">${routeName}</span>`;
                    }).join('')}
                    ${routes.length === 0 ? '<span style="color: var(--text-secondary);">No routes assigned</span>' : ''}
                </div>

                ${capacity.overflow > 0 ? `
                <div class="info-box danger" style="margin-top: 15px;">
                    <strong>${typeof i18n !== 'undefined' ? i18n.t('status.overflow', 'Overflow') : 'Overflow'}:</strong> ${capacity.overflow} ${typeof i18n !== 'undefined' ? i18n.t('data.carts', 'carts') : 'carts'} ${typeof i18n !== 'undefined' ? i18n.t('cartLoading.dontFit', 'don\'t fit. Consider external carrier or neighbor\'s truck.') : 'don\'t fit. Consider external carrier or neighbor\'s truck.'}
                </div>
                ` : ''}
            `;

            return card;
        }

        function updateCartList(allCarts) {
            const container = document.getElementById('cart-list-by-route');
            container.innerHTML = '';

            const cartsByRoute = {
                rijnsburg: [],
                aalsmeer: [],
                naaldwijk: []
            };

            allCarts.forEach(cart => {
                if (cartsByRoute[cart.route]) {
                    cartsByRoute[cart.route].push(cart);
                }
            });

            Object.keys(ROUTES).forEach(routeKey => {
                const route = ROUTES[routeKey];
                const carts = cartsByRoute[routeKey] || [];
                
                const routeCard = document.createElement('div');
                routeCard.className = 'card';
                routeCard.style.marginBottom = '20px';
                
                routeCard.innerHTML = `
                    <h3>Route ${route.id}: ${route.name} (${route.departureTime})</h3>
                    <div class="cart-list">
                        ${carts.length > 0 ? carts.map(cart => {
                            const truck1Text = typeof i18n !== 'undefined' ? i18n.t('cartLoading.truck1', 'Truck 1') : 'Truck 1';
                            const truck2Text = typeof i18n !== 'undefined' ? i18n.t('cartLoading.truck2', 'Truck 2') : 'Truck 2';
                            const notAssignedText = typeof i18n !== 'undefined' ? i18n.t('cartLoading.notAssigned', 'Not Assigned') : 'Not Assigned';
                            const truckAssignment = cartLoadingOptimizer.truckAssignments.truck1.carts.includes(cart) ? truck1Text :
                                                   cartLoadingOptimizer.truckAssignments.truck2.carts.includes(cart) ? truck2Text : notAssignedText;
                            const cartTypeText = cart.type === 'danish' 
                                ? (typeof i18n !== 'undefined' ? i18n.t('cartLoading.danishCart', 'Danish Cart') : 'Danish Cart')
                                : (typeof i18n !== 'undefined' ? i18n.t('cartLoading.standardCart', 'Standard Cart') : 'Standard Cart');
                            return `
                                <div class="cart-item ${cart.type}">
                                    <div>
                                        <strong>${cart.client}</strong>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
                                            ${cartTypeText} ‚Ä¢ ${truckAssignment}
                                        </div>
                                    </div>
                                    <div>
                                        <span class="badge ${cart.type === 'danish' ? 'primary' : 'info'}">
                                            ${cart.type === 'danish' ? 'D' : 'S'}
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('') : '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No carts for this route</div>'}
                    </div>
                `;
                
                container.appendChild(routeCard);
            });
        }

        function updateSummaryStats(result) {
            const allCarts = result.allCarts;
            const truck1Capacity = cartLoadingOptimizer.getTruckCapacity('truck1');
            const truck2Capacity = cartLoadingOptimizer.getTruckCapacity('truck2');
            const totalOverflow = truck1Capacity.overflow + truck2Capacity.overflow;
            const routesCovered = new Set([...result.truck1.routes, ...result.truck2.routes]).size;

            document.getElementById('total-carts').textContent = allCarts.length;
            document.getElementById('carts-assigned').textContent = result.truck1.carts.length + result.truck2.carts.length;
            document.getElementById('overflow-count').textContent = totalOverflow;
            document.getElementById('routes-covered').textContent = `${routesCovered}/3`;
        }

        // Auto-optimize on load if orders available
        document.addEventListener('DOMContentLoaded', () => {
            // Try loading from storage first
            if (orderManager) {
                orderManager.loadOrdersFromStorage();
                
                // If orders found, auto-optimize
                if (orderManager.orders && orderManager.orders.length > 0) {
                    console.log('üì¶ Found orders, auto-optimizing...');
                    optimizeCartLoading();
                } else {
                    // Show helpful message
                    console.log('üí° No orders found. Click "Optimize Cart Loading" to load demo data automatically.');
                }
            }
        });
        
        // Toggle sidebar collapse (desktop)
        function toggleSidebarCollapse() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        }
        
        // Toggle sidebar on mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('open') && 
                !sidebar.contains(event.target) && 
                !menuBtn.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });
        
        // Restore sidebar state on load
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed && window.innerWidth > 768) {
                sidebar.classList.add('collapsed');
            }
        });
        
        // Language switcher
        window.setLanguage = function(lang) {
            if (typeof i18n !== 'undefined') {
                i18n.setLanguage(lang);
                updateLanguageButtons();
            }
        };
        
        function updateLanguageButtons() {
            if (typeof i18n === 'undefined') return;
            const currentLang = i18n.getLanguage();
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(`lang-btn-${currentLang}`);
            if (activeBtn) activeBtn.classList.add('active');
        }
    
        // Logout function - clears session and redirects to login
        function handleLogout() {
            if (confirm(typeof i18n !== 'undefined' ? i18n.t('common.confirmLogout', 'Are you sure you want to logout?') : 'Are you sure you want to logout?')) {
                // Clear all session data
                localStorage.removeItem('zuidplas_logged_in');
                localStorage.removeItem('florinet_token');
                localStorage.removeItem('florinet_token_expiry');
                localStorage.removeItem('florinet_username');
                localStorage.removeItem('florinet_password');
                localStorage.removeItem('zuidplas_demo_mode');
                sessionStorage.clear();
                
                // Redirect to login
                window.location.href = 'login.html';
            }
        }
        
        // Make logout function global
        window.handleLogout = handleLogout;

    </script>
</body>